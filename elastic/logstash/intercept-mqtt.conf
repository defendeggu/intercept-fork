# Logstash Pipeline for INTERCEPT MQTT Integration
# Receives MQTT messages from Mosquitto broker and indexes to Elasticsearch
#
# Prerequisites:
#   - Logstash MQTT input plugin: bin/logstash-plugin install logstash-input-mqtt
#   - Mosquitto broker running with INTERCEPT connected
#
# Usage:
#   bin/logstash -f intercept-mqtt.conf

input {
  mqtt {
    host => "${MQTT_HOST:localhost}"
    port => "${MQTT_PORT:1883}"
    username => "${MQTT_USER:}"
    password => "${MQTT_PASS:}"
    topic => "intercept/#"
    codec => json
    client_id => "logstash-intercept"
    qos => 1
  }
}

filter {
  # Extract decoder type from MQTT topic (intercept/pocsag -> pocsag)
  if [@metadata][mqtt_topic] {
    grok {
      match => { "[@metadata][mqtt_topic]" => "intercept/%{WORD:decoder}" }
    }
  }

  # Ensure @timestamp exists and is properly formatted
  if ![timestamp] and ![@timestamp] {
    ruby {
      code => "event.set('@timestamp', Time.now)"
    }
  } else if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }

  # Add metadata fields
  mutate {
    add_field => { "[@metadata][index_prefix]" => "intercept" }
  }

  # Decoder-specific processing
  if [decoder] == "adsb" {
    # Create geo_point for aircraft position
    if [lat] and [lon] {
      mutate {
        add_field => { "[location][lat]" => "%{lat}" }
        add_field => { "[location][lon]" => "%{lon}" }
      }
      mutate {
        convert => {
          "[location][lat]" => "float"
          "[location][lon]" => "float"
        }
      }
    }

    # Ensure numeric fields are properly typed
    mutate {
      convert => {
        "altitude" => "integer"
        "speed" => "integer"
        "heading" => "integer"
        "vertical_rate" => "integer"
        "squawk" => "string"
      }
    }
  }

  if [decoder] == "aprs" {
    # Create geo_point for APRS station position
    if [lat] and [lon] {
      mutate {
        add_field => { "[location][lat]" => "%{lat}" }
        add_field => { "[location][lon]" => "%{lon}" }
      }
      mutate {
        convert => {
          "[location][lat]" => "float"
          "[location][lon]" => "float"
        }
      }
    }
  }

  if [decoder] == "sensor" {
    # Ensure sensor numeric fields are properly typed
    mutate {
      convert => {
        "temperature_C" => "float"
        "temperature_F" => "float"
        "humidity" => "integer"
        "pressure_hPa" => "float"
        "wind_avg_km_h" => "float"
        "rain_mm" => "float"
        "battery_ok" => "boolean"
      }
    }
  }

  if [decoder] == "rtlamr" {
    # Ensure meter reading fields are properly typed
    mutate {
      convert => {
        "consumption" => "integer"
        "meter_id" => "string"
      }
    }
  }

  if [decoder] == "acars" {
    # Ensure ACARS numeric fields are properly typed
    mutate {
      convert => {
        "level" => "float"
        "freq" => "float"
      }
    }
  }

  if [decoder] == "pocsag" {
    # Ensure pager fields are properly typed
    mutate {
      convert => {
        "address" => "string"
        "function" => "string"
      }
    }
  }
}

output {
  # Output to Elasticsearch with daily indices
  elasticsearch {
    hosts => ["${ES_HOST:localhost:9200}"]
    user => "${ES_USER:}"
    password => "${ES_PASS:}"
    index => "intercept-%{[decoder]}-%{+YYYY.MM.dd}"
    template_name => "intercept"
    template_overwrite => true
  }

  # Optional: Debug output to stdout
  # stdout { codec => rubydebug }
}
